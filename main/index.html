<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
    integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
    integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous" />
  <title>AIGB</title>
  <style>
    .slidecontainer {
      width: 100%;
    }
    
    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 25px;
      background: #d3d3d3;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }
    
    .slider:hover {
      opacity: 1;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 25px;
      height: 25px;
      background: #28A745;
      cursor: pointer;
    }
    
    .slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      background: #28A745;
      cursor: pointer;
    }
  </style>
</head>

<body onLoad="javascript:WebSocketBegin()">
  <header id="main-header" class="py-2 bg-success text-white">
    <div class="container">
      <div class="row justify-content-md-center">
        <div class="col-md-6 text-center">
          <h1><i class="fas fa-leaf"></i>  AIGB Control Panel v0</h1>
        </div>
      </div>
    </div>
  </header>

  <section class="py-5 bg-white">
    <div class="container">
      <h2 class="deck-title">Quick controls</h2>
      <div class="row">
        
                    <!-- Pumpblock -->
        <div class="col">
          <div class="card bg-light m-2" style="min-height: 15rem;">


            <div class="card-header">Pump controls</div>
            <div class="card-body">
              <h5 class="card-title">Pump power: <em id="wpp_plc">0</em>%</h5>
              <div class="slidecontainer">
                <input type="range" min="0" max="100" value="0" class="slider" id="wpp_out">
              </div>
              <div style="padding-top:40px;" class="d-flex justify-content-center"><button id="wpb_btn"><i id="wpb_out" class="fas fa-power-off fa-2x" style="color:red;"></i></button></div>
            </div>
          </div>
        </div>
                    <!-- Lightblock -->
        <div class="col">
          <div class="card bg-light m-2" style="min-height: 15rem;">
            <div class="card-header">Light controls</div>
            <div class="card-body">
              <h5 class="card-title">Light power: <em id="lcp_plc">0</em>%</h5>
              <div class="slidecontainer">
                <input type="range" min="0" max="100" value="0" class="slider" id="lcp_out">
              </div>
              <div class="card-text">
                <h6 class="card-title">Sensor readouts</h6>
                <div class="text-left">Top: <em id="lcs_tout">0</em> lm</div> <div class="text-center">Mid: <em id="lcs_mout">0</em> lm</div> <div class="text-right">Bottom: <em id="lcs_bout">0</em> lm</div>
              </div>
              <h5 class="card-title d-flex justify-content-center"><i class="fas fa-lightbulb" id="lcc_in"></i>RGB</h5>
              <div class="slidecontainer">
                <input style="background:#000000;"type="range" min="0" max="255" value="0" class="slider" id="lcc_rout">
                <input style="background:#000000;"type="range" min="0" max="255" value="0" class="slider" id="lcc_gout">
                <input style="background:#000000;"type="range" min="0" max="255" value="0" class="slider" id="lcc_bout">
              </div>
              <div style="padding-top:40px;" class="d-flex justify-content-center"><button id="lcb_btn"><i id="lcb_out" class="fas fa-power-off fa-2x" style="color:red;"></i></button></div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card bg-light m-2" style="min-height: 15rem;">
            <div class="card-header">Profile selection</div>
            <div class="card-body">
              <h5 class="card-title">Light power: <em id="lcp_plc">0</em>%</h5>
              <div class="slidecontainer">
                <input type="range" min="0" max="100" value="0" class="slider" id="lcp_out">
              </div>
              <div class="card-text">
                <h6 class="card-title">Sensor readouts</h6>
                <div class="text-left">Top: <em id="lcs_tout">0</em> lm</div> <div class="text-center">Mid: <em id="lcs_mout">0</em> lm</div> <div class="text-right">Bottom: <em id="lcs_bout">0</em> lm</div>
              </div>
              <h5 class="card-title d-flex justify-content-center"><i class="fas fa-lightbulb" id="lcc_in"></i>RGB</h5>
              <div class="slidecontainer">
                <input style="background:#000000;"type="range" min="0" max="255" value="0" class="slider" id="lcc_rout">
                <input style="background:#000000;"type="range" min="0" max="255" value="0" class="slider" id="lcc_gout">
                <input style="background:#000000;"type="range" min="0" max="255" value="0" class="slider" id="lcc_bout">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</body>
<script type="text/javascript">
  var ws;

  window.addEventListener('beforeunload', (event) => {
    ws.close();
    // Cancel the event as stated by the standard.
    event.preventDefault();
    // Older browsers supported custom message
    event.returnValue = '';
  });

  function WebSocketBegin() {
    if ("WebSocket" in window) {
      // Let us open a web socket
      ws = new WebSocket(
        location.hostname.match(/\.husarnetusers\.com$/) ? "wss://" + location.hostname + "/__port_8000/ws" : "ws://" + location.hostname + ":8000/ws"
      );
      // ws = new WebSocket(
      //   "wss://fc9434c5513c3543753124468f76fa507-8000.husarnetusers.com/ws"
      // );
      // ws = new WebSocket(
      //   "ws://esp32websocket:8000/ws"
      // );

      ws.onopen = function () {
        // Web Socket is connected
      };

      ws.onmessage = function (evt) {
        //create a JSON object
        var jsonObject = JSON.parse(evt.data);
        var cnt = jsonObject.counter;
        var btn = jsonObject.button;

        document.getElementById("cnt").innerText = cnt;
        if (btn == 1) {
          document.getElementById("btn").style.color = "green";
        } else {
          document.getElementById("btn").style.color = "red";
        }
      };

      ws.onclose = function (evt) {
        if (evt.wasClean) {
          alert(`[close] Connection closed cleanly, code=${evt.code} reason=${evt.reason}`);
        } else {
          // e.g. server process killed or network down
          // event.code is usually 1006 in this case
          alert('[close] Connection died');
        }
      };

      ws.onerror = function (error) {
        alert(`[error] ${error.message}`);
      }


    } else {
      // The browser doesn't support WebSocket
      alert("WebSocket NOT supported by your Browser!");
    }
  }
  // Pump cntrol script
  var wpp_el = document.getElementById("wpp_out");
  var wpp_val = document.getElementById("wpp_plc");
  wpp_el.oninput = function(){
    wpp_val.innerHTML = this.value;
  }

  var wpb_el = document.getElementById("wpb_btn");
  var wpb_val = 0;
  wpb_el.onclick = function(){
    if (wpb_val == 1) {
      document.getElementById("wpb_out").style.color = "red";
      wpb_val = 0;
    } else {
      wpb_val = 1;
      document.getElementById("wpb_out").style.color = "green";
    }
  }

  //Light control script
  var lcp_el = document.getElementById("lcp_out");
  var lcp_val = document.getElementById("lcp_plc");
  lcp_el.oninput = function(){
    lcp_val.innerHTML = this.value;
  }
  var lcc_rel = document.getElementById("lcc_rout");
  var lcc_gel = document.getElementById("lcc_gout");
  var lcc_bel = document.getElementById("lcc_bout");
  var lcc_r = 0
  var lcc_g = 0
  var lcc_b = 0
  setCol = function() {
    v = "#" + (lcc_r.toString(16).length==1 ? "0" + lcc_r.toString(16) : lcc_r.toString(16)) + 
    (lcc_g.toString(16).length==1 ? "0" + lcc_g.toString(16) : lcc_g.toString(16)) + 
    (lcc_b.toString(16).length==1 ? "0" + lcc_b.toString(16) : lcc_b.toString(16))

    document.getElementById("lcc_in").style.color = v
  }
  lcc_rel.oninput = function() {
    lcc_r = parseInt(this.value);
    v = lcc_r.toString(16);
    if (v.length == 1){
      v = "0" + v;
    }
    v = "#"+v+"0000";
    this.style.background = v;
    setCol();
  }
  lcc_gel.oninput = function() {
    lcc_g = parseInt(this.value);
    v = lcc_g.toString(16);
    if (v.length == 1){
      v = "0" + v;
    }
    v = "#00"+v+"00";
    this.style.background = v;
    setCol();
  }
  lcc_bel.oninput = function() {
    lcc_b = parseInt(this.value);
    v = lcc_b.toString(16);
    if (v.length == 1){
      v = "0" + v;
    }
    v = "#0000"+v;
    this.style.background = v;
    setCol();
  }
  var lcb_el = document.getElementById("lcb_btn");
  var lcb_val = 0;
  lcb_el.onclick = function(){
    if (lcb_val == 1) {
      document.getElementById("lcb_out").style.color = "red";
      lcb_val = 0;
    } else {
      lcb_val = 1;
      document.getElementById("lcb_out").style.color = "green";
    }
  }

  
</script>
</html>